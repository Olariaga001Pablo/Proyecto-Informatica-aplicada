<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo Rápido - Solar</title>
    <!-- Importación del CSS local (CLAVE para el estilo) -->
    <link rel="stylesheet" href="./style.css"> 
</head>
<body>
    <!-- Botón para volver a la página principal (index.html) -->
    <button class="btn-volver" onclick="window.location.href = '../../index.html';">
        &larr;
    </button>

    <!-- CLASE CRÍTICA: Centra el contenido y elimina el margen del sidebar -->
    <div class="main-simple">
        <!-- CLASE CRÍTICA: Contenedor principal con sombra y fondo blanco -->
        <div class="calculadora-wrapper">
            
            <!-- Contenedor del Formulario -->
            <div class="form-calculo">
                <h2 class="form-title">Calculadora de Sistemas Solares</h2>
                
                <form id="calculo-form">
                    <div class="form-group">
                        <label for="potenciaDemanda">Potencia de Demanda (Watts)</label>
                        <!-- ID: potenciaDemanda -->
                        <input type="number" id="potenciaDemanda" name="potenciaDemanda" placeholder="Ej: 2500" required min="10">
                    </div>

                    <div class="form-group">
                        <label for="tipoPanel">Tipo de Panel a Usar</label>
                        <!-- ID: tipoPanel -->
                        <select id="tipoPanel" name="tipoPanel" required>
                            <option value="" disabled selected>Seleccione la potencia</option>
                            <!-- Las opciones se cargarán por JavaScript para usar las constantes de la lógica de cálculo -->
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Calcular Requerimientos</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('calculo-form').reset(); document.getElementById('error-message').textContent = ''; document.getElementById('results-container').innerHTML = '';">Limpiar</button>
                    </div>

                    <!-- Contenedor para mensajes de error -->
                    <div id="error-message" class="error-message" style="display: none;"></div>
                </form>
            </div>

            <!-- Contenedor de Resultados -->
            <div class="results-container-simple">
                <h3 class="form-title">Resultados del Cálculo</h3>
                <!-- ID: results-container -->
                <div id="results-container">
                    <!-- Los resultados se inyectarán aquí por JavaScript -->
                    <p class="result-item"><strong>Paneles Requeridos:</strong> <span>---</span></p>
                    <p class="result-item"><strong>Inversor(es) Sugerido:</strong> <span>---</span></p>
                    <p class="result-item"><strong>Potencia Total Instalada (W):</strong> <span>---</span></p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Lógica de Renderizado y Cálculo
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('calculo-form');
            const resultsContainer = document.getElementById('results-container');
            const errorElement = document.getElementById('error-message');
            const tipoPanelSelect = document.getElementById('tipoPanel');

            // Hardcodeamos los tipos de panel ya que el frontend no puede leer el backend directamente
            // Si la lógica de cálculo cambia, estos valores deben actualizarse aquí.
            const TIPOS_PANEL = {
                PANEL_450W: 450,
                PANEL_550W: 550,
            };

            // 1. Cargar Opciones del Selector de Paneles
            for (const [key, value] of Object.entries(TIPOS_PANEL)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = `${key.replace('_', ' ')} (${value} W)`;
                tipoPanelSelect.appendChild(option);
            }

            // 2. Manejador del Formulario
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                resultsContainer.innerHTML = '';
                errorElement.style.display = 'none';
                errorElement.textContent = '';

                const potenciaDemandaWatts = parseInt(document.getElementById('potenciaDemanda').value);
                const potenciaPanelWatts = parseInt(tipoPanelSelect.value);

                if (isNaN(potenciaDemandaWatts) || potenciaDemandaWatts <= 0) {
                    errorElement.textContent = 'Por favor, ingrese una potencia de demanda válida.';
                    errorElement.style.display = 'block';
                    return;
                }
                
                if (isNaN(potenciaPanelWatts) || potenciaPanelWatts <= 0) {
                    errorElement.textContent = 'Por favor, seleccione un tipo de panel válido.';
                    errorElement.style.display = 'block';
                    return;
                }

                try {
                    // LLAMADA IPC: Usa la API expuesta por preload.js
                    const result = await window.utilAPI.calcularSistema(potenciaDemandaWatts, potenciaPanelWatts);
                    window.utilAPI.log(`Resultado del cálculo: ${JSON.stringify(result)}`);
                    
                    // Mostrar Resultados
                    resultsContainer.innerHTML = `
                        <p class="result-item"><strong>Potencia Panel Seleccionado:</strong> <span>${potenciaPanelWatts} W</span></p>
                        <p class="result-item"><strong>Paneles Requeridos:</strong> <span>${result.paneles}</span></p>
                        <p class="result-item"><strong>Inversor(es) Sugerido:</strong> <span>${result.inversor.cantidad} x ${result.inversor.tipo.replace('INVERSOR_', '').replace('KW', ' KW')}</span></p>
                        <p class="result-item"><strong>Potencia Total Instalada:</strong> <span>${result.potenciaTotal} W</span></p>
                    `;
                    
                } catch (error) {
                    console.error('Error al solicitar cálculo:', error);
                    errorElement.textContent = 'Error interno del sistema de cálculo. Consulte la consola.';
                    errorElement.style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>